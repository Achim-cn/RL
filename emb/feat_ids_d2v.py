# coding: utf-8
import pandas as pd
from gensim.models.doc2vec import Doc2Vec, TaggedDocument

import warnings,os,gc
warnings.filterwarnings('ignore')

if not os.path.exists("../data/embfeatures"):
    os.mkdir("../data/embfeatures")
if not os.path.exists("../data/id2index"):
    os.mkdir("../data/id2index")

feed_info = pd.read_csv('../data/feed_info.csv')

# feedid,authorid,videoplayseconds,description,ocr,asr,bgm_song_id,bgm_singer_id,manual_keyword_list,machine_keyword_list,manual_tag_list,machine_tag_list,description_char,ocr_char,asr_char
# 43549,6165,38,104741 122649 8109 117252 65632 23463 118668 45861 8109 142955 27736 21751 112151 116906 32715 93520 32714 80461 8109 93563 102383 10952 48706 12885 68441 93563 8097 134820 55911 80449 79213 23233 13997 53706 104690 6994,139499 59421 82007 142955 27736 83577 52394 112151 116906 93520 80461 82007 90327 28303 133091 82007 118636 99614 22694 93541 94993 82007 133091 45443 118749 82007 17273 26295 755 82007 79531 45861 60826 12240 99614 16648 117253 82007 6488 128286 16917 82007 66297 6994 146483 6994 6994 6994 92811 6478 123078 107293 82007 116352 47035 90992 111660 93115 7660 6994 91023 6994 91023 6994 117843 118696 125334 49255 140964 78844 101640 117843 82007 133091 92811 12240 123078 25794 82007 67209 140959 105807 27736 79314 68476 82007 46310 73451 133091 99617 8041 60574 150245 142561 90217 118696 125334 27736 82007 90992 99617 82007 46310 6994 73451 133091 99617 8041 23648 150245 106770 78844 133091 82007 502 94016 102311 37630 55139 93566 82007 55633 140609 27736 21763 16194 82007 3030 140609 27736 21763 16194 82007 110142 94993 136991 56344 11145 27736 83577 82007 12240 54654 25794 82007 121844 127586 12666 82007 287 826 122748 27736 140959 109451 82007 44399 136492 978 88576 5976 25794,142955 27736 83577 103956 32010 34170 89740 90327 8109 28303 31798 12214 19942 99614 22694 93541 94993 133091 84618 118749 8109 1556 26295 79531 4724 12240 99614 16648 117253 79314 93536 120507 6486 128286 122159 46310 131225 6478 123078 140147 118668 14312 8109 118668 25794 99656 125334 49255 140964 101640 134892 40003 46310 131225 12240 123078 25794 44506 116906 25794 9844 27736 112516 51703 142561 146692 125334 27736 75770 4438 133091 122013 94016 29200 55139 93566 8109 115201 93566 29288 3030 100909 27736 21763 16194 8109 86461 119958 8109 101594 10143 27736 83577 12240 31336 85335 8109 12852 26661 4438 49448 12205 27736 140959 93524 8109 134871 37630 55139 93566 27736 15998 65632 99614 77895 26564 129634 33988 27736 53964 116914 78817 4438,19356,11703,15506;7715;17582,26334;219;25209;7715;18541,81;269;159;6,269 0.8525666;81 0.8525666;8 1.1e-07;306 0.0;207 6.31e-06;10 0.27404302,26439 5247 6426 3827 1882 26018 20744 22204 30024 24307 10436 1882 2203 26439 6243 21632 3713 15640 25926 7357 20823 7356 17870 1882 20857 3653 11877 24307 21492 17178 11341 10043 20833 15357 20857 1872 12681 5043 17859 17859 17531 15208 2597 3161 22626 27055 22439 20077,25926 8491 13394 2203 26439 6243 33054 16435 11945 15640 25926 20823 17870 2874 25926 32378 20860 20268 27664 2820 13505 22179 5043 20838 21147 20268 27664 10326 31491 27464 20744 15640 29786 17597 199 20857 26054 10436 13681 2841 22179 3701 22474 1531 28575 3805 14875 32495 10517 11575 2200 20831 27464 24513 17596 25782 24307 22539 20268 24815 20752 1801 20292 20292 26208 26456 32499 20268 17549 22539 20292 17442 22626 26208 20268 27664 10517 11575 2841 27464 8481 22806 25926 4196 23482 6243 17596 15382 10517 14121 20268 27664 22181 6155 17602 13616 33234 3882 1531 20049 26456 32499 6243 20268 22181 10517 14121 20268 27664 22181 6155 17602 5344 33234 29751 29959 17442 20268 27664 4153 22241 21456 5033 22741 12837 5061 17870 20860 12604 3546 6243 22546 11662 3588 716 3546 6243 22546 11662 3588 24513 21147 32499 5043 12785 10086 22439 6243 33054 16435 2841 21468 22474 8481 26641 8481 2874 2923 66 219 32386 6243 25926 4196 24364 10043 11575 11877 29786 7305 19565 1341 8481,2203 26439 6243 33054 16435 16307 17070 24908 25920 7778 19891 2874 25926 1882 32378 20860 2227 3899 2820 13505 28798 22179 5043 20838 21147 20268 27664 18757 31491 27464 1882 17577 5966 29786 17597 20857 26054 10436 8740 2841 22179 3701 22474 17596 20833 29095 12762 1529 28575 27209 10517 11575 28798 2200 20831 27464 17531 66 24307 11388 6946 1882 24307 8481 22214 32499 20268 17549 22539 20292 22626 30042 11789 27664 10517 11575 28798 2841 27464 8481 10080 25926 8481 2206 6243 17596 10134 11796 3882 1531 14070 26456 32499 6243 10130 15911 969 20268 27664 2239 21498 21456 5033 20857 7799 5061 17870 20860 1882 7799 27464 20860 24513 1520 716 22446 6243 22546 11662 3588 1882 24513 20863 30038 15360 1882 22610 26084 26183 6243 33054 16435 2841 2066 21465 22474 5596 1882 15036 31177 21633 8512 969 30035 15921 2813 6243 25926 4196 20827 1882 30026 12837 5061 17870 20860 6243 17855 15360 20744 22179 17181 5967 24307 11574 11581 14292 6243 28598 6259 25930 17420 969
# 77432,9386,60,35753 27736 146603 73055 11794 101761 11794 8109 16933 52236 96307 12240 31279 137786 46760 8109 95030 7626 35990 8105 93533 8106 134820 35990 53496,35753 146603 73055 11794 101761 67496 16933 52236 12240 99614 137786 46760 22893 99893 149481 90267 32443 83722 49523 44399 30521 73055 11794 101761 11794 4430 26692 32395 4431 85868 20248 109427 77075 24343,146739 14368 79290 79213 47366 8109 33194 11989 31279 139153 7739 27736 97114 111182 8109 32443 83722 49523 44399 83265 73055 11794 11794 12240 12220 9949 45012 73055 25794 66512 8109 13547 79213 117050 121114 12240 23840 25794 79682 27736 5251 4438 32443 83722 110142 85502 8109 23509 12220 149649 133296 25794 118749 8109 134878 79213 47366 8109 73757 9844 106949 102036 113903 100901 8109 11989 104154 116819 147841 45012 22454 25794 118749 4438 71331 135636 27736 9949 147789 107673 125472 8109 92687 37527 50006 9844 102383 55805 49985 4438 86458 59637 12240 45012 32443 83722 23729 25794 79303 113003 8109 32443 83722 35339 72615 4101 27736 59394 57464 94842 112151 62197 93563 106949 25794 8109 90290 36623 93541 66151 8109 81787 12240 37630 45121 96353 27736 56338 96353 93541 66151 136194 22682 8109 121528 142314 85907 25794 45121 96353 27736 56338 8109 56338 146823 27736 107962 129369 56522 18710 8109 121274 139898 56981 27736 112151 8109 96307 96353 27736 105115 75625 12127 11989 80297 116819 44399 118814 121428 57464 141821 117050 8109 49523 104109 8109 4101 23944 92857 57464 25794 4438 75625 106972 59637 137786 18422 25794 4438 135636 27736 85592 114620 61803 8109 134878 79213 47366 110142 128739 42526 129746 57464 8109 96150 22454 19019 93541 93536 44352 8109 9844 77895 9844 121428 22414 25794 110142 149596 100491 8109 93324 56522 27013 118480 22682 145811 78276 32440 85907 25794 118668 86339 90810 2517 2517 47082 107673 45061 72615 108277 8109 40621 106949 144795 8109 134449 25794 8109 62436 117780 8109 121577 137786 24885 85056 146492 61803 4438 96439 116906 75625 12240 107973 25794 94171 8109 107673 77905 9973 109024 25794 110142 135558 63991 56280 8109 6510 6510 93541 56280 12240 63991 25794 118668 107962 4438 73757 9844 135558 107962 145339 38594 27736 31877 8109 106949 30426 72615 105251 75625 12127 56344 45012 85051 25794 38594 8109 26597 93541 66151 137550 107973 71826 35380 135636 27736 85592 107673 132715 58694 27736 53807 146823 8109 121274 79213 117050 121114 8109 29802 26564 44398 7409 77601 75625 12127 122650 25794 8109 38594 96099 44137 8109 150623 147516 62339 23632 7307 57464 56344 47366 25794 110142 93536 46071 27736 45829 8109 34517 15099 25794 6851 40277 142518 27736 8109 77895 62690 27736 56976 37527 93563 45412 100901 52611 10818 4438 64771 4438 147565 142518 9844 125334 93563 148254 52611 25794 128896 100901 79290 66989 4438,,,8199;18322;4243,24078;19924,194;267;159;6,267 0.99293476;194 0.99293476,31010 32495 6243 13923 15360 30483 2709 26084 2709 1882 6976 1119 32191 66 21460 2841 30031 2220 11445 20077 30055 21492 1882 10436 1216 9019 20016 106 12187 1878 20831 1879 12681 106 12187 28535 11383,31010 32495 13923 15360 30483 2709 26084 15160 6976 1119 32191 66 2841 22179 11445 20077 30055 21492 5104 5329 28798 33075 20070 7261 24307 5318 24513 10083 10043 32066 17278 30483 2709 26084 2709 961 1018 28161 7235 962 8890 27393 9781 14241 5513,7259 20851 5061 26207 17573 17531 15117 20072 1882 12584 15360 9119 29499 30031 2220 1487 1487 20857 28704 6243 12787 23108 5061 25630 1882 7261 24307 5318 24513 10083 10043 7261 19631 30483 2709 2709 2841 22717 16567 19020 10226 30483 8481 29242 23786 1882 12762 29499 17531 10045 24513 12371 28798 2841 26084 14040 8481 20857 2818 6243 32280 969 7261 24307 5318 24513 3907 32376 1882 6267 23705 22717 27061 17571 33330 8481 31491 27464 1882 30031 17531 15117 20072 1882 16435 2206 23786 2682 32028 15366 32280 22439 1882 9119 29499 7305 13842 25897 23492 27788 10226 4967 8481 31491 27464 969 23804 27464 19800 66 6243 16567 19020 7685 30038 23963 24513 6491 1882 11670 6439 8512 11383 2206 3653 11877 12669 11364 969 24513 20859 15360 2841 10226 7261 24307 5318 20078 8481 17585 25121 1882 7261 24307 5318 3779 19565 16174 30749 9202 6243 15268 10134 28798 31238 11371 15640 14040 20857 23786 8481 1882 20085 11598 11354 20838 11792 5329 1882 28161 12678 2841 12837 17770 9119 21492 6243 25926 12860 21492 20838 11792 5329 14040 13660 5033 1882 9416 16174 12836 18765 19777 20072 8481 17770 9119 21492 6243 25926 12860 1882 25926 12860 32562 6243 5270 25926 10434 18895 12836 14049 11296 1882 25123 20851 31075 12960 6243 15640 1882 21460 21492 6243 20824 8512 8486 25298 15360 9119 29499 21456 26322 25897 10043 11792 27050 28798 21800 10045 1882 24513 10083 13394 8512 1882 30749 9202 5416 20860 31376 28798 8481 969 8486 23801 15360 11445 20077 30055 32376 8481 969 19800 66 6243 2820 10424 19791 29781 4947 13394 1882 30031 17531 15117 20072 24513 28680 24307 7261 19631 2223 28798 1882 20857 1541 4967 20857 2239 20838 20833 32505 8512 1882 2206 17181 2206 27050 4944 8481 24513 16133 22351 1882 9416 20087 12836 5414 6269 6426 23786 5033 32333 17264 7259 19777 20072 8481 24307 13016 22351 30043 95 25926 28798 25926 28798 24513 7305 23963 3826 2585 16174 23786 10045 1882 5009 11383 23786 32066 1882 29922 8481 1882 16323 25616 70 1882 32505 28798 11445 20077 7771 21474 18881 32500 4947 13394 969 16435 18605 25926 8486 2841 27464 20072 8481 8486 32562 26446 1882 23963 17190 14223 19804 13858 14040 8481 24513 4956 30328 26543 12771 1882 1541 1541 20838 12771 2841 30328 26543 8481 24307 5270 25926 969 16435 2206 4956 5270 25926 26493 6426 27464 6243 22439 3879 1882 23786 10038 18876 16174 23343 8486 25298 15360 12785 10226 18876 8481 6426 27464 1882 5990 20838 11792 5329 7799 32336 27464 20072 17076 32562 28703 25306 25299 19800 66 6243 2820 10424 23963 9201 10222 12955 24307 6243 25274 15360 32562 1882 25123 20851 17531 10045 24513 12371 28798 1882 19800 2220 5967 10042 22629 32221 16174 8486 25298 15360 27343 8481 1882 6426 27464 32028 32376 26444 12650 1882 5990 15640 20825 8481 22179 26467 30055 12653 67 2233 28798 12785 15117 20072 8481 24513 20833 10230 5311 6243 17173 20090 1882 2206 2223 16265 14743 8481 1202 27976 9187 31605 6243 1882 17181 16650 6243 24442 8512 20857 11680 17278 22439 1211 14040 27061 4948 969 30031 15640 969 1804 18895 31605 2206 32499 20857 21494 24937 1211 14040 8481 28161 25920 22439 17573 4913 29499 969
# 12921,2996,15,114413 107973 117252 27736 41035 32715 125374 121275 32714 134820 130882 134820 121275,,,10288,11354,,11696;6926,202;23;160;6,23 0.64771646;202 0.64771646,27077 10050 27464 20072 26018 6243 21492 14750 7357 31937 5036 11720 12949 7356 12681 19901 11379 12681 11720 12949,,
# 34538,12577,18,60473 9864 8109 135558 108803 89307 37630 6481 40061 93566 13997 49752 88822 35990,39654 95201 22675 49521 135558 108803 89307 37630 6481 40061 93566,7446 47082 37630 99660 9844 113002 9844 113002 9844 27 39909 78557 30819 95343 17745 54593 879 84541 33616 56196 93542 95463 8109 26564 99569 4438,24435,13645,5454;1197;3727,,328;13;159;6,267 0.21298289;191 0.21298289;8 0.34298885;306 0.0;207 0.03609685;10 0.26915717,21489 24672 2223 1882 4956 1545 10424 19791 12837 1525 9116 20860 3161 11278 19642 106 12187,9015 21209 5026 11192 4956 1545 10424 19791 12837 1525 9116 20860,20825 13395 14765 24513 7305 12837 10337 8885 2206 21457 2206 21457 2206 19634 5318 19634 19634 5318 5318 26439 21465 31376 30749 27298 12358 255 2841 15640 17766 20833 12743 20839 21292 1882 5967 20857 17446 12836 969
user_action = pd.read_csv('../data/user_action.csv').drop_duplicates(subset=["userid","feedid"],keep="last").reset_index(drop=True)

# test = pd.read_csv('../data/test_a.csv')

data = user_action[["userid","feedid"]].drop_duplicates(subset=["userid","feedid"],keep="last").reset_index(drop=True)
# print('*****************data*******************')
# print(data)
# test = test[["userid","feedid"]]
# data = pd.concat([data, test], axis=0).reset_index(drop=True)
data = data.merge(feed_info[["feedid","authorid"]], how='left',on="feedid")
# print(data)
# userA : 1  2  3 4 5 6
# userB: 1,3,4,6,7
# feedA: 1, 2, 3 ,4 ,5
# feedB : 6,7,8,9,10

def Doc2vec(df,main_col,gp_col,dim_n):
    print(main_col,gp_col)
    df[gp_col] = df[gp_col].astype(str)
    tmp = df.groupby(main_col)[gp_col].agg(list).reset_index()
    # df[gp_col] = df[gp_col].astype(int)
    tmp[gp_col] = tmp[gp_col].apply(lambda x: [str(i) for i in x])
    print(tmp)
    documents = [TaggedDocument(doc, [i]) for i, doc in enumerate(tmp[gp_col])]
    model = Doc2Vec(documents, workers=20, min_count=5, vector_size=dim_n, window=25, dm=0)
    vectors = model.docvecs.vectors
    print(vectors)
    df_w2v = pd.DataFrame(vectors, columns=['{mc}_{gc}_d2v'.format(mc=main_col[:-2],gc=gp_col[:-2])+str(i) for i in range(dim_n)])
    print('----------------------------------')
    print(df_w2v)
    df_feat = pd.concat([tmp[[main_col]], df_w2v], axis=1)
    df_feat.to_pickle("../data/embfeatures/{mc}_{gc}_d2v_{dim}.pickle".format(mc=main_col[:-2],gc=gp_col[:-2],dim=str(dim_n)))


dim_n = 150
for main_col, gp_col in [('userid', 'feedid'), ('userid', 'authorid'), ('feedid', 'userid'), ('authorid', 'userid')]:
    if not os.path.exists("../data/embfeatures/{mc}_{gc}_d2v_{dim}.pickle".format(mc=main_col[:-2],gc=gp_col[:-2],dim=str(dim_n))):
        Doc2vec(data,main_col,gp_col,dim_n)
    else:
        print("../data/embfeatures/{mc}_{gc}_d2v_{dim}.pickle".format(mc=main_col[:-2],gc=gp_col[:-2],dim=str(dim_n)))
